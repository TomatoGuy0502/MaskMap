<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <title>全台藥局口罩數量查詢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoma4dB8ZXyRUgonlHmCLMQorqoI2MK38" async defer></script>
  </head>
  <body>
    <div id="app">
      <div id="map"></div>
      <div class="updatedTime">最後更新時間：</br>{{updatedTime}}</div>
    </div>
    
    
    <script>
      const googleMap = new Vue({
        el: '#app',
        data: {
          map: null,
          pharmacyList: [],
          updatedTime:''
        },
        methods: {
          initMap() {
            this.map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 22.9958252, lng: 120.2106385},
              zoom: 14.5,
              mapTypeId: 'roadmap',
              fullscreenControl: false,
              mapTypeControl: false,
              streetViewControl: false,
              styles: [
                {
                  "featureType": "road.highway",
                  "stylers": [
                    {
                      "visibility": "simplified"
                    }
                  ]
                }
              ]
            });
            // this.map.data.loadGeoJson('https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json?fbclid=IwAR3gV7DKwPyHAv6Q-5bE_EhwFui4ivWa5PVmvNfWntMEUzLMIdqFChNpHWA')
          },
          getData() {
            axios
            .get('https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json?fbclid=IwAR3gV7DKwPyHAv6Q-5bE_EhwFui4ivWa5PVmvNfWntMEUzLMIdqFChNpHWA')
            .then(response =>{
              this.pharmacyList = response.data.features;
              this.updatedTime = this.pharmacyList[0].properties.updated

              var infowindow = new google.maps.InfoWindow();
              this.pharmacyList.forEach( (item) => {
                var latLng = new google.maps.LatLng(item.geometry.coordinates[1], item.geometry.coordinates[0]);

                let marker = new google.maps.Marker({
                  position: latLng,
                  map: this.map,
                });
                //有剩餘數量才顯示口罩 否則為一般的圖標
                if(item.properties.mask_adult || item.properties.mask_child){
                  marker.setIcon('./image/mask.png')
                } else {
                  marker.setIcon('./image/no_mask.png')
                }

                google.maps.event.addListener(marker, 'click', (function(marker, item) {
                  return function() {
                    infowindow.setContent(
                      '<div class="info_content">'+
                        '<p class="name">' + item.properties.name + '</p>'+
                        '<div class="numbers">'+
                          '<p>' + '成人口罩：' + item.properties.mask_adult + '</p>'+
                          '<p>' + '兒童口罩：' + item.properties.mask_child + '</p>'+
                        '</div>'+
                        '<p class="address">'+ '地址：' + item.properties.address + '</p>'+
                      '</div>'
                    );
                    infowindow.open(map, marker);
                  }
                })(marker, item));

              })
            });
          },
        },
        created() {
          window.onload = () => {
            this.initMap();
            this.getData();
          };
        }
      });
    </script>
  </body>
</html>