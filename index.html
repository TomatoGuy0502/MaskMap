<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <title>全台藥局口罩數量查詢</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoma4dB8ZXyRUgonlHmCLMQorqoI2MK38" async defer></script>
    <script type="text/javascript" src="./js/markerclustererplus@4.0.1.min.js"></script>
  </head>
  <body>
    <div id="app">
      <div id="map"></div>
      <div class="control_panel">
        <div class="updatedTime">最後更新時間：</br>{{updatedTime}}</div>
        <button class="btn_check" @click="drawer = true">查看有口罩診所</button>
      </div>
      <div class="control_drawer_layer" v-show="drawer" @click.self="drawer = false">
        <transition name="fade">
          <div class="control_drawer" v-show="drawer">
            <div class="control_drawer__info">
              <h1>即時口罩地圖</h1>
              <div>
                <p class="source">資料來源：<a href="">這裡</a></p>
                <p class="date">{{date}}</p>
              </div>
            </div>
            <div class="control_drawer__reminder">
              <p class="day_of_week">{{dayOfWeek}}</p>
              <p class="id_number">{{lastIdNumber}}</p>
              <img src="./images/banner_announce_fix.png" alt="Reminder">
            </div>
            <div class="control_drawer__search">
              <label for="search">用地址查詢</label>
              <input type="search" id="search" placeholder="請輸入地址" autocomplete="off">
              <i class="fas fa-search"></i>
            </div>
            <div class="control_drawer__list"></div>
          </div>
        </transition>
      </div>
      
    </div>
    
    
    <script>
      const googleMap = new Vue({
        el: '#app',
        data: {
          map: null,
          dayOfWeek: "",
          lastIdNumber:"",
          date: "",
          updatedTime:'',
          drawer: false,
          hasMaskList: [],
          shopList: [],
          cityList: {
            "台北": [],
            "新北": [],
            "基隆": [],
            "宜蘭": [],
            "桃園": [],
            "新竹": [],
            "苗栗": [],
            "台中": [],
            "彰化": [],
            "南投": [],
            "雲林": [],
            "嘉義": [],
            "台南": [],
            "高雄": [],
            "屏東": [],
            "澎湖": [],
            "花蓮": [],
            "台東": [],
            "金門": [],
            "連江": [],
          },
          citySelected: '請選擇'
        },
        methods: {
          initMap() {
            this.map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 22.9926135, lng: 120.2173127},
              zoom: 14,
              mapTypeId: 'roadmap',
              fullscreenControl: false,
              mapTypeControl: false,
              streetViewControl: false,
              styles: [
                {
                  "featureType": "road.highway",
                  "stylers": [
                    {
                      "visibility": "simplified"
                    }
                  ]
                },
                {
                  "featureType": "poi.business",
                  "stylers": [
                    {
                      "visibility": "off"
                    }
                  ]
                },
              ]
            });
            
            // this.map.data.loadGeoJson('https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json?fbclid=IwAR3gV7DKwPyHAv6Q-5bE_EhwFui4ivWa5PVmvNfWntMEUzLMIdqFChNpHWA')
          },
          getData() {
            axios
            .get('https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json')
            .then(response =>{
              var infowindow = new google.maps.InfoWindow();
              var markers = [];
              response.data.features.forEach( (item) => {
                this.shopList.push(item.properties)

                //==========顯示更新時間==========
                if(!this.updatedTime && item.properties.updated){
                  this.updatedTime = item.properties.updated
                }

                //==========設定圖標內容==========
                let marker = new google.maps.Marker({
                  position: {lat:item.geometry.coordinates[1], lng:item.geometry.coordinates[0]},
                  map: this.map,
                });
                markers.push(marker);

                // 有剩餘數量才顯示口罩 否則為一般的圖標
                if(item.properties.mask_adult || item.properties.mask_child){
                  this.hasMaskList.push(item.properties)
                  marker.setIcon('./images/doctor.png')
                } else {
                  marker.setIcon('./images/no_mask.png')
                }

                //==========設定info視窗==========
                marker.addListener('click', (function(marker, item) {
                  return function() {
                    infowindow.setContent(
                      '<div class="info_content">'+
                        '<p class="info_content__name">' + item.properties.name + '</p>'+
                        '<div class="info_content__numbers">'+
                          '<p>' + '成人口罩：' + item.properties.mask_adult + '</p>'+
                          '<p>' + '兒童口罩：' + item.properties.mask_child + '</p>'+
                        '</div>'+
                        '<p class="info_content__address">'+ '地址：' + item.properties.address + '</p>'+
                      '</div>'
                    );
                    infowindow.open(map, marker);
                  }
                })(marker, item));

              });
              var markerCluster = new MarkerClusterer(this.map, markers, {
                gridSize: 40,
              });
              this.classifyCity()
            });
          },
          classifyCity() {
            //==========行政區分類==========
            this.hasMaskList.forEach( (city, index, arr) => {
              if(city.address[0] == '臺'){
                arr[index].address = arr[index].address.replace('臺','台')
              }else if(city.address[0] == '淡'){
                arr[index].address = '新北' + arr[index].address
              }
              //地址的前2字有在cityList內才存入
              if(Object.keys(this.cityList).indexOf(arr[index].address.slice(0,2)) != -1){
                this.cityList[city.address.slice(0,2)].push(city)
              }
            })
          },
          setInfo() {
            let dayOfWeek = new Date().getDay();
            this.dayOfWeek = "星期"+"日一二三四五六".charAt(dayOfWeek);
            if(dayOfWeek === 0){
              this.lastIdNumber = "任意數字";
            }else{
              this.lastIdNumber = dayOfWeek % 2 ? "1.3.5.7.9" : "0.2.4.6.8";
            };
            this.date = new Date().getFullYear()+ "年" + (new Date().getMonth()+1) + "月" + new Date().getDate() + "日";
          }
        },
        created() {
          this.setInfo();
          window.onload = () => {
            this.initMap();
            this.getData();
          };
        }
      });
    </script>
  </body>
</html>